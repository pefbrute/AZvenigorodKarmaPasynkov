# Документация проекта AZvenigorod

**AZvenigorod (Zvenigorod Karma Pasynkov)** — это обучающее Android-приложение на базе Jetpack Compose, предназначенное для детей и взрослых, желающих изучить географию и достопримечательности города Звенигород. Приложение использует систему интервальных повторений (SRS) для эффективного запоминания местоположений и внешнего вида объектов.

## 1. Технологический стек
- **Язык**: Kotlin
- **UI**: Jetpack Compose
- **База данных**: Room (SQLite)
- **Картография**: OSMDroid (OpenStreetMap)
- **Архитектура**: MVVM (Model-View-ViewModel)
- **Алгоритм обучения**: Упрощенный SM-2 (SuperMemo-2)
- **Поддержка объектов**: Точки (памятники), Области (районы), Линии (улицы/дороги)

## 2. Структура проекта (Архитектура)

### 2.1. Данные (`data`)
- **`QuizItem` (QuizEntity.kt)**: Главная сущность. Содержит:
  - Имя, описание, имя изображения.
  - Координаты (`latitude`, `longitude`).
  - Тип объекта (`POINT`, `LINE`, `POLYGON`).
  - Геометрию (`geometryData`) для полигонов.
  - Данные SRS (дата следующего повторения, интервал, фактор легкости) отдельно для режимов карты и картинок.
- **`SRSRepository`**: Слой бизнес-логики. Отвечает за:
  - Выборку объектов, которые пора повторить (`getDueItems`).
  - Обработку результатов ответа и пересчет интервалов по алгоритму SM-2 (`processReview`).
  - Подбор похожих вариантов (дистракторов) для тестов на основе близости координат.
- **`DataSeeder`**: Отвечает за первичную инициализацию БД из JSON-файла (`zvenigorod_seed.json`).

### 2.2. Пользовательский интерфейс (`ui`)
- **`MapQuizScreen`**: Основной экран игры. Обрабатывает три режима:
  1. `SHOW_NAME`: Показывает точку/область на карте, пользователь выбирает название из вариантов.
  2. `NAME_POKE`: Дает название объекта, пользователь должен ткнуть в правильное место на карте.
  3. `IMAGE_GUESS`: Показывает фото, пользователь выбирает название.
- **`MapQuizViewModel`**: Управляет состоянием экрана (`QuizState`), логикой переключения вопросов и взаимодействием с репозиторием.
- **`GameMode` / `QuizMode`**: Перечисления, определяющие текущий тип активности и тип вопроса.

### 2.3. Картография и утилиты (`map`, `util`)
- **`MapController`**: Обертка над OSMDroid `MapView`. Реализует:
  - Центрирование карты.
  - Добавление маркеров.
  - Рисование линий (путь между ответом пользователя и правильной точкой).
  - Рисование полигонов и кругов (актуально для районов).
- **`GeometryUtils`**: Математические функции для работы с гео-данными:
  - Вычисление расстояния (формула гаверсинусов).
  - Парсинг строк координат `geometryData`.
  - Проверка вхождения точки в полигон (Ray casting).
  - Вычисление расстояния от точки до полилинии или полигона.

## 3. Логика обучения (SRS)
Приложение отслеживает прогресс пользователя по каждому объекту в двух независимых направлениях:
1. **Визуальное узнавание** (по фото).
2. **Пространственное знание** (по карте).

Если пользователь отвечает правильно и быстро (малое расстояние на карте или верный выбор из списка), интервал до следующего показа объекта увеличивается. Если ошибается — интервал сбрасывается, и объект будет показан снова в ближайшее время.

## 4. Формат данных (zvenigorod_seed.json)
Данные импортируются из файла ресурсов. Важные поля:
- `kind`: Например, `monument`, `church`, `district_anchor` (район), `street` (улица).
- `answerRadiusM`: Допустимая погрешность при клике на карту (для районов она больше).
- `geometryData`: Координаты границ для районов (полигоны) или осевой линии для улиц (линии) в формате `[[lat,lon],...]`.

### 4.1 Пример добавления улицы
```json
{
  "id": "zvg_street_moskovskaya",
  "name": "Московская улица",
  "kind": "street",
  "group": "streets",
  "lat": 55.7303,
  "lon": 36.8554,
  "imageName": "zvg_moskovskaya_segment_1",
  "geometryData": "[[55.7297,36.8519],[55.7304,36.8558],[55.7314,36.8612]]"
}
```
### 4.2 Одна улица — много фотографий
Если нужно, чтобы одну дорогу можно было узнавать по разным участкам, используйте массив `images`. Каждое изображение создаст отдельный вопрос в викторине со своим прогрессом обучения (SRS).

```json
{
  "id": "zvg_street_moskovskaya",
  "name": "Московская улица",
  "kind": "street",
  "geometryData": "[[55.7297,36.8519],[55.7304,36.8558]]",
  "lat": 55.7303, "lon": 36.8554, // Дефолтный центр
  "images": [
    { "imageName": "mosk_seg_1", "lat": 55.7297, "lon": 36.8519 },
    { "imageName": "mosk_seg_2", "lat": 55.7304, "lon": 36.8558 }
  ]
}
```
*Важно: `geometryData` (синяя линия на карте) будет одинаковой для всех сегментов этой улицы.*

---
*Документация создана для внутреннего использования и взаимодействия с ИИ-ассистентами.*
